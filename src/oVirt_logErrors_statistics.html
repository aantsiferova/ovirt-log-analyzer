<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8" />
      <link href="https://www.highcharts.com/highslide/highslide.css" rel="stylesheet" />
      <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
      <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      <script type="text/javascript" src="https://code.highcharts.com/highcharts.js"></script>
      <script type="text/javascript" src="https://code.highcharts.com/highcharts-more.js"></script>
      <script type="text/javascript" src="https://code.highcharts.com/modules/exporting.js"></script>
      <script src="stat_to_plot.js"></script>
      <script src="https://www.highcharts.com/samples/static/highslide-full.min.js"></script>
      <script src="https://www.highcharts.com/samples/static/highslide.config.js" charset="utf-8"></script>
      <link rel="stylesheet" type="text/css" href="https://www.highcharts.com/samples/static/highslide.css" />
  </head>
  
  <body style="margin:0;padding:0">
    <div id="container" style="width: 100%; height: calc(100vh - 5rem);">Loading....</div>
    <script>
    var chart;
    $(function() {
      Highcharts.setOptions({"lang": {}, "global": {}});
      var option = {
        chart: {
          renderTo: 'container',
          type: 'area',
		  zoomType: 'x',
          margin: 100
        },
        title: {
          text: 'oVirt log errors statistics'
        },
        //subtitle: {
        //    text: 'Subtitle'
        //},
        xAxis: {
            categories: [],
            tickmarkPlacement: 'on',
            title: {
                enabled: false
            },
            labels: {
              format: '{value:%H:%M:%S}'
            }
        },
        yAxis: {
            title: {
                text: 'Number of errors'
            },
            labels: {
                formatter: function () {
                    return this.value;
                }
            }
        },
        tooltip: {
            split: true,
            valueSuffix: ' errors',
            valueDecimals: 2
        },
        plotOptions: {
            area: {
                //stacking: 'normal',
                //lineColor: '#666666',
                lineWidth: 0,
                marker: {
                    radius: 2,
                    lineWidth: 1,
                    lineColor: '#666666'
                }
            }
        },
        series: {}
      }
      chart = new Highcharts.Chart(option);
    });

    $(function(){
      var new_cats = []
      for (var logname in errors_data) {
        for (var time in errors_data[logname]) {
          if($.inArray(time, new_cats)<0) {
            //dt = new Date(time*1000);
            //new_cats.push(dt.getDate()+'.'+dt.getMonth()+'.'+dt.getFullYear()+' '+dt.getHours()+':'+dt.getMinutes()+':'+dt.getSeconds());
            new_cats.push(Number(time)*1000);
          } 
        }
      }
      chart.xAxis[0].setCategories(new_cats);

//     for (var logname in errors_data) {
//        var errors_stat_series = [];
//        for (var time_err in errors_data[logname]) {
//          var num_of_errors = 0;
//          for (var msg_id in errors_data[logname][time_err]) {
//              num_of_errors += errors_data[logname][time_err][msg_id];
//          }
//          errors_stat_series.push([Number(time_err)*1000, num_of_errors]);
//        }

      for (var logname in errors_data) {
        var errors_stat_series = [];
        for (i = 0; i < new_cats.length; i++) {
          var dt = (Number(new_cats[i])/1000).toString();
          if (dt in errors_data[logname]) {
            var num_of_errors = 0;
            for (msg_id in errors_data[logname][dt]) {
              num_of_errors += errors_data[logname][dt][msg_id]
            }
            errors_stat_series.push(num_of_errors);
          } else {
            errors_stat_series.push(0);
          }
        }
        chart.addSeries({name: logname,
                          data: errors_stat_series,
                          lineWidth: 1,
                          point: {
                            events: {
                              click: function (e) {
                                      console.log(e);
                                      console.log((Number(e.point.category)/1000).toString());
                                      console.log(errors_data[e.point.series.name]);
                                      hs.htmlExpand(null, {
                                        pageOrigin: {
                                          x: e.pageX || e.clientX,
                                          y: e.pageY || e.clientY
                                        },
                                        headingText: this.series.name + ' | ' + e.point.y + ' errors',
                                        maincontentText: GenErrText(errors_data[e.point.series.name][(Number(e.point.category)/1000).toString()]),
                                        width: GenErrText(errors_data[e.point.series.name][(Number(e.point.category)/1000).toString()]).length * 10 > 500 ? 500 : GenErrText(errors_data[e.point.series.name][(Number(e.point.category)/1000).toString()]).length * 10
                                      });
                              }
                            }
                          }
        });
      }
    });
    var GenErrText = function(time_err){
      text = ''
      for (err_key in time_err) {
        text += '<i>' + err_key + '</i>: ' + time_err[err_key] + '<br>'
      }
      return text;
    };
    </script>
  </body>
</html>